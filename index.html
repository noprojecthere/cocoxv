<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üé¨ Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script src="https://cdn.dashjs.org/v4.7.4/dash.all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--pri:#6C5CE7;--pri2:#A29BFE;--acc:#00CEC9;--bg:#0a0a0f;--bgc:#12121a;--bgctrl:rgba(10,10,15,0.92);--tx:#fff;--txd:#8b8b9e;--red:#FF6B6B;--g1:linear-gradient(135deg,#6C5CE7,#00CEC9);--g2:linear-gradient(135deg,#fd79a8,#6C5CE7)}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow-x:hidden}
    .loader{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s,visibility .4s}
    .loader.hide{opacity:0;visibility:hidden;pointer-events:none}
    .spin{width:50px;height:50px;border:4px solid rgba(108,92,231,.2);border-top-color:var(--pri);border-radius:50%;animation:sp .7s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .loader p{margin-top:16px;color:var(--txd);font-weight:500;font-size:15px}
    .err{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;z-index:9998;padding:20px;text-align:center}
    .err.show{display:flex}
    .err .material-icons-round{font-size:72px;color:var(--red);margin-bottom:16px}
    .err h2{font-size:22px;margin-bottom:8px}
    .err p{color:var(--txd);max-width:450px;line-height:1.6;font-size:15px}
    .err pre{background:rgba(255,255,255,.05);padding:12px;border-radius:8px;margin-top:12px;font-size:11px;color:var(--red);max-width:500px;overflow-x:auto;text-align:left;white-space:pre-wrap}
    .err a{margin-top:20px;padding:12px 28px;background:var(--g1);border:none;color:#fff;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}
    .land{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px 20px;text-align:center}
    .land.show{display:flex}
    .land-logo{width:90px;height:90px;background:var(--g1);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:44px;margin-bottom:20px;box-shadow:0 16px 50px rgba(108,92,231,.3)}
    .land h1{font-size:28px;margin-bottom:10px}
    .land>p{color:var(--txd);font-size:15px;max-width:480px;line-height:1.7;margin-bottom:28px}
    .ubox{background:var(--bgc);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:20px;text-align:left;max-width:460px;width:100%}
    .ubox h3{font-size:12px;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
    .ubox code{display:block;background:rgba(255,255,255,.04);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:6px;color:var(--pri2);word-break:break-all}
    .hdr{background:var(--bgc);border-bottom:1px solid rgba(255,255,255,.05);padding:12px 18px;display:flex;align-items:center;gap:12px}
    .hdr-logo{width:40px;height:40px;border-radius:11px;background:var(--g1);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .hdr-info{flex:1;min-width:0}
    .hdr-t{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdr-m{font-size:11px;color:var(--txd);display:flex;align-items:center;gap:7px;margin-top:2px}
    .live-d{width:7px;height:7px;background:var(--red);border-radius:50%;animation:pul 2s infinite}
    @keyframes pul{0%,100%{opacity:1}50%{opacity:.35}}
    .live-t{background:var(--red);color:#fff;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;text-transform:uppercase}
    .m-logo{width:38px;height:38px;border-radius:10px;object-fit:cover;background:rgba(255,255,255,.04)}
    .pw{width:100%;background:#000}
    .pb{position:relative;width:100%;padding-top:56.25%;background:#000;cursor:pointer;overflow:hidden}
    .pb video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;background:#000}
    .buf{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:10;pointer-events:none}
    .buf.show{display:flex}
    .buf .spin{width:42px;height:42px;border-color:rgba(255,255,255,.15);border-top-color:var(--pri2)}
    .bp{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:72px;height:72px;background:rgba(108,92,231,.82);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:11;cursor:pointer;transition:transform .2s,opacity .3s;backdrop-filter:blur(8px)}
    .bp:hover{transform:translate(-50%,-50%) scale(1.08)}
    .bp .material-icons-round{font-size:36px;color:#fff;margin-left:3px}
    .bp.hide{opacity:0;pointer-events:none}
    .tst{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.5);background:rgba(0,0,0,.65);color:#fff;border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;opacity:0;z-index:50;pointer-events:none;transition:opacity .2s,transform .2s;backdrop-filter:blur(8px)}
    .tst.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .tst .material-icons-round{font-size:28px}
    .sz{position:absolute;top:0;width:50%;height:100%;display:flex;align-items:center;justify-content:center;z-index:15;pointer-events:none}
    .sz.l{left:0}.sz.r{right:0}
    .sb{background:rgba(255,255,255,.1);border-radius:50%;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transform:scale(.5);transition:opacity .3s,transform .3s}
    .sb.show{opacity:1;transform:scale(1)}
    .sb .material-icons-round{font-size:24px}
    .sb span{font-size:10px;font-weight:600;margin-top:2px}
    .ct{position:absolute;bottom:0;left:0;width:100%;background:linear-gradient(transparent,rgba(0,0,0,.85));padding:44px 12px 8px;z-index:20;transition:opacity .3s;opacity:0}
    .pb:hover .ct,.pb.cv .ct{opacity:1}
    .prw{width:100%;height:20px;display:flex;align-items:center;cursor:pointer;margin-bottom:2px}
    .prb{width:100%;height:3px;background:rgba(255,255,255,.15);border-radius:3px;position:relative;transition:height .15s}
    .prw:hover .prb{height:6px}
    .prbf,.prpl{position:absolute;top:0;left:0;height:100%;border-radius:3px;pointer-events:none}
    .prbf{background:rgba(255,255,255,.2)}
    .prpl{background:var(--g1)}
    .prth{position:absolute;top:50%;width:13px;height:13px;background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 6px rgba(0,0,0,.35);opacity:0;transition:opacity .15s;pointer-events:none}
    .prw:hover .prth{opacity:1}
    .cr{display:flex;align-items:center;justify-content:space-between}
    .cl,.crr{display:flex;align-items:center;gap:2px}
    .cb{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:#fff;border-radius:9px;cursor:pointer;transition:background .2s;position:relative}
    .cb:hover{background:rgba(255,255,255,.1)}
    .cb .material-icons-round{font-size:21px}
    .tm{font-size:11px;color:rgba(255,255,255,.7);font-weight:500;margin-left:5px;font-variant-numeric:tabular-nums;white-space:nowrap}
    .vg{display:flex;align-items:center}
    .vsw{width:0;overflow:hidden;transition:width .3s;display:flex;align-items:center}
    .vg:hover .vsw{width:65px}
    .vs{width:65px;height:3px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.15);border-radius:3px;outline:none;cursor:pointer}
    .vs::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:#fff;border-radius:50%;cursor:pointer}
    .mn{position:absolute;bottom:calc(100% + 6px);right:0;background:var(--bgctrl);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:5px 0;min-width:150px;display:none;backdrop-filter:blur(18px);box-shadow:0 14px 44px rgba(0,0,0,.45);z-index:100;max-height:260px;overflow-y:auto}
    .mn.show{display:block}
    .mn-t{padding:7px 13px;font-size:10px;font-weight:700;color:var(--txd);text-transform:uppercase;letter-spacing:1px}
    .mn-o{padding:8px 13px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:13px;font-weight:500;transition:background .15s}
    .mn-o:hover{background:rgba(255,255,255,.06)}
    .mn-o.act{color:var(--acc)}
    .mn-o.act::after{content:'check';font-family:'Material Icons Round';font-size:16px;color:var(--acc)}
    .qb{font-size:8px;background:var(--g1);padding:2px 5px;border-radius:3px;font-weight:700;margin-left:5px;color:#fff}
    .mn::-webkit-scrollbar{width:3px}
    .mn::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
    .inf{background:var(--bgc);padding:14px 18px;border-top:1px solid rgba(255,255,255,.04)}
    .inf-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .ch{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,.04);padding:5px 11px;border-radius:16px;font-size:11px;font-weight:500;color:var(--txd)}
    .ch .material-icons-round{font-size:14px;color:var(--pri2)}
    .tb{background:var(--g2);color:#fff;padding:5px 11px;border-radius:16px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}
    .fsa .hdr,.fsa .inf,.fsa .dbg{display:none}
    .fsa .pw{width:100vw;height:100vh}
    .fsa .pb{padding-top:0;width:100%;height:100%}
    .dbg{background:var(--bgc);padding:14px 18px;border-top:1px solid rgba(255,255,255,.04);display:none}
    .dbg.show{display:block}
    .dbg h4{color:var(--acc);font-size:12px;margin-bottom:8px;cursor:pointer}
    .dbg pre{background:rgba(0,0,0,.3);padding:10px;border-radius:8px;font-size:10px;color:var(--txd);overflow-x:auto;max-height:250px;overflow-y:auto;white-space:pre-wrap;word-break:break-all}
    @media(max-width:768px){
      .hdr{padding:10px 12px}.hdr-t{font-size:13px}
      .cb{width:32px;height:32px}.cb .material-icons-round{font-size:19px}
      .tm{font-size:10px}.vg{display:none}
      .inf{padding:10px 12px}.ct{padding:30px 8px 6px}
    }
  </style>
</head>
<body>
<div class="loader" id="loader"><div class="spin"></div><p>Loading Stream...</p></div>
<div class="err" id="errS">
  <span class="material-icons-round">error_outline</span>
  <h2>Stream Error</h2>
  <p id="errM">Something went wrong.</p>
  <pre id="errD" style="display:none"></pre>
  <a href="/">‚Üê Go Home</a>
</div>
<div class="land" id="land">
  <div class="land-logo">üé¨</div>
  <h1>Stream Player</h1>
  <p>HLS, DASH, ClearKey DRM with custom headers support.</p>
  <div class="ubox">
    <h3>üìå How to Use</h3>
    <code>?id=test</code>
    <code>?id=testdash</code>
    <code>?id=testdrm</code>
    <code>?id=testproxy</code>
  </div>
</div>
<div id="main" style="display:none">
  <header class="hdr">
    <div class="hdr-logo">üé¨</div>
    <div class="hdr-info">
      <div class="hdr-t" id="mT">Loading...</div>
      <div class="hdr-m"><div class="live-d"></div><span class="live-t">LIVE</span><span id="mG">‚Äî</span></div>
    </div>
    <img id="mL" class="m-logo" src="" alt="" style="display:none">
  </header>
  <div class="pw"><div class="pb" id="pB">
    <video id="vid" playsinline></video>
    <div class="buf" id="bufO"><div class="spin"></div></div>
    <div class="bp" id="bigP"><span class="material-icons-round">play_arrow</span></div>
    <div class="tst" id="tst"><span class="material-icons-round" id="tI"></span><span id="tT"></span></div>
    <div class="sz l"><div class="sb" id="sL"><span class="material-icons-round">replay_10</span><span>10s</span></div></div>
    <div class="sz r"><div class="sb" id="sR"><span class="material-icons-round">forward_10</span><span>10s</span></div></div>
    <div class="ct">
      <div class="prw" id="prW"><div class="prb"><div class="prbf" id="prBf"></div><div class="prpl" id="prPl"></div><div class="prth" id="prTh"></div></div></div>
      <div class="cr">
        <div class="cl">
          <button class="cb" id="ppB"><span class="material-icons-round" id="ppI">play_arrow</span></button>
          <button class="cb" id="skB"><span class="material-icons-round">replay_10</span></button>
          <button class="cb" id="skF"><span class="material-icons-round">forward_10</span></button>
          <div class="vg"><button class="cb" id="mtB"><span class="material-icons-round" id="vI">volume_up</span></button><div class="vsw"><input type="range" class="vs" id="vS" min="0" max="100" value="100"></div></div>
          <span class="tm" id="tmD">0:00 / LIVE</span>
        </div>
        <div class="crr">
          <button class="cb" id="spB"><span class="material-icons-round">speed</span>
            <div class="mn" id="spM">
              <div class="mn-o" data-s="0.25">0.25x</div><div class="mn-o" data-s="0.5">0.5x</div><div class="mn-o" data-s="0.75">0.75x</div>
              <div class="mn-o act" data-s="1">Normal</div><div class="mn-o" data-s="1.25">1.25x</div><div class="mn-o" data-s="1.5">1.5x</div><div class="mn-o" data-s="2">2x</div>
            </div>
          </button>
          <button class="cb" id="qB"><span class="material-icons-round">tune</span>
            <div class="mn" id="qM"><div class="mn-t">Quality</div><div class="mn-o act" data-lv="-1">Auto</div></div>
          </button>
          <button class="cb" id="piB"><span class="material-icons-round">picture_in_picture_alt</span></button>
          <button class="cb" id="fsB"><span class="material-icons-round" id="fsI">fullscreen</span></button>
        </div>
      </div>
    </div>
  </div></div>
  <div class="inf"><div class="inf-r">
    <span class="tb" id="sT">‚Äî</span>
    <div class="ch"><span class="material-icons-round">hd</span><span id="cQ">Auto</span></div>
    <div class="ch"><span class="material-icons-round">speed</span><span id="cS">1x</span></div>
    <div class="ch" id="dC" style="display:none"><span class="material-icons-round">lock</span><span>ClearKey</span></div>
    <div class="ch" id="pC" style="display:none"><span class="material-icons-round">vpn_lock</span><span>Proxy</span></div>
  </div></div>
  <div class="dbg" id="dbg"><h4 onclick="document.getElementById('dbg').classList.remove('show')">üîß Debug (click close)</h4><pre id="dbgLog"></pre></div>
</div>

<script>
var $=function(id){return document.getElementById(id)};
var vid=$('vid'),pB=$('pB'),loader=$('loader'),errS=$('errS'),errM=$('errM'),errD=$('errD');
var land=$('land'),main=$('main'),bigP=$('bigP'),bufO=$('bufO');
var ppB=$('ppB'),ppI=$('ppI'),skB=$('skB'),skF=$('skF');
var mtB=$('mtB'),vI=$('vI'),vS=$('vS'),tmD=$('tmD');
var prW=$('prW'),prPl=$('prPl'),prBf=$('prBf'),prTh=$('prTh');
var qB=$('qB'),qM=$('qM'),spB=$('spB'),spM=$('spM');
var piB=$('piB'),fsB=$('fsB'),fsI=$('fsI');
var tst=$('tst'),tI=$('tI'),tT=$('tT');
var mT=$('mT'),mG=$('mG'),mL=$('mL');
var sT=$('sT'),cQ=$('cQ'),cS=$('cS'),dC=$('dC'),pC=$('pC');
var dbgEl=$('dbg'),dbgLog=$('dbgLog');

var hlsP=null,dashP=null,mData=null;
var ctTO=null,tsTO=null,dbTO2=null,taps=0,logs=[];

function log(m){
  logs.push('['+new Date().toLocaleTimeString()+'] '+m);
  if(logs.length>100)logs.shift();
  dbgLog.textContent=logs.join('\n');
  dbgLog.scrollTop=999999;
  console.log('[P]',m);
}

mT.addEventListener('dblclick',function(){dbgEl.classList.toggle('show')});

// ================================
// KEY CONVERSION - THE REAL FIX
// ================================
function toBase64url(input){
  if(!input) return null;
  input = input.trim();

  // 1) Check if HEX (only 0-9 a-f A-F, even length)
  if(/^[0-9a-fA-F]+$/.test(input) && input.length % 2 === 0){
    log('Converting HEX ‚Üí base64url: '+input.substring(0,20)+'...');
    try{
      var bytes=[];
      for(var i=0;i<input.length;i+=2){
        bytes.push(parseInt(input.substr(i,2),16));
      }
      var binary='';
      for(var j=0;j<bytes.length;j++){
        binary += String.fromCharCode(bytes[j]);
      }
      var b64=btoa(binary);
      var result=b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      log('Result: '+result);
      return result;
    }catch(e){
      log('Hex conversion failed: '+e.message);
      return input;
    }
  }

  // 2) Check if standard BASE64 (has + or / or =)
  if(input.indexOf('+')!==-1 || input.indexOf('/')!==-1 || input.indexOf('=')!==-1){
    log('Converting BASE64 ‚Üí base64url');
    var result=input.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    log('Result: '+result);
    return result;
  }

  // 3) Already BASE64URL or unknown format - use as-is
  log('Using as-is (base64url or raw): '+input.substring(0,20));
  return input;
}

// ================================
// INIT
// ================================
function gId(){return new URLSearchParams(window.location.search).get('id')}

async function init(){
  var id=gId();
  if(!id){loader.classList.add('hide');land.classList.add('show');return}
  log('Loading: '+id);
  try{
    var r=await fetch('/api/match?id='+encodeURIComponent(id));
    if(!r.ok){var e;try{e=await r.json()}catch(x){e={error:'Not found'}};shErr(e.error,JSON.stringify(e,null,2));return}
    mData=await r.json();
    log('Title: '+mData.title);
    log('Type: '+mData.type);
    log('URL: '+mData.url);
    if(mData.drm)log('DRM: '+mData.drm.type+' KID:'+mData.drm.keyId+' KEY:'+mData.drm.key);
    if(mData.headers)log('Headers: '+JSON.stringify(mData.headers));
    setUI();startP();
  }catch(e){log('ERROR: '+e.message);shErr('Failed: '+e.message)}
}

function shErr(m,d){
  loader.classList.add('hide');
  errM.textContent=m||'Error';
  if(d){errD.textContent=d;errD.style.display='block'}
  errS.classList.add('show');
}

function setUI(){
  mT.textContent=mData.title||'Stream';mG.textContent=mData.group||'Live';
  document.title=mData.title||'Player';
  if(mData.logo){mL.src=mData.logo;mL.style.display='block';mL.onerror=function(){mL.style.display='none'}}
  sT.textContent=(mData.type||'?').toUpperCase();
  if(mData.drm)dC.style.display='flex';
  if(mData.headers&&Object.keys(mData.headers).length>0)pC.style.display='flex';
}

// ================================
// START PLAYER
// ================================
function startP(){
  var u=mData.url, t=mData.type||aT(u), h=mData.headers||{}, d=mData.drm;
  var hH=Object.keys(h).length>0;
  log('Starting: type='+t+' proxy='+hH+' drm='+(d?d.type:'none'));
  try{
    if(t==='hls') iHLS(u,h,hH);
    else if(t==='dash') iDASH(u,h,d);
    else{vid.src=hH?pU(u,h):u;vid.load()}
  }catch(e){log('START ERROR: '+e.message);shErr(e.message)}
  loader.classList.add('hide');main.style.display='block';
}

function aT(u){if(u.indexOf('.m3u8')!==-1)return'hls';if(u.indexOf('.mpd')!==-1)return'dash';return'direct'}
function pU(u,h){return'/api/proxy?url='+encodeURIComponent(u)+'&headers='+encodeURIComponent(JSON.stringify(h))}

// ================================
// HLS
// ================================
function iHLS(u,h,up){
  if(typeof Hls==='undefined'||!Hls.isSupported()){
    if(vid.canPlayType('application/vnd.apple.mpegurl')){vid.src=up?pU(u,h):u;vid.load();return}
    shErr('HLS not supported');return;
  }
  var src=up?pU(u,h):u;
  log('HLS source: '+src.substring(0,100));

  hlsP=new Hls({
    maxBufferLength:30,maxMaxBufferLength:60,enableWorker:true,startLevel:-1,
    fragLoadingTimeOut:20000,manifestLoadingTimeOut:15000,levelLoadingTimeOut:15000
  });
  hlsP.loadSource(src);
  hlsP.attachMedia(vid);

  hlsP.on(Hls.Events.MANIFEST_PARSED,function(ev,data){
    log('‚úÖ HLS OK! '+data.levels.length+' levels');
    bHQ(data.levels);
    vid.play().catch(function(e){log('Autoplay blocked')});
  });
  hlsP.on(Hls.Events.LEVEL_SWITCHED,function(ev,data){uHQ(data.level)});
  hlsP.on(Hls.Events.ERROR,function(ev,data){
    log('‚ùå HLS: '+data.details+(data.fatal?' FATAL':''));
    if(data.fatal){
      if(data.type===Hls.ErrorTypes.NETWORK_ERROR){
        log('Network error - retrying in 3s');
        setTimeout(function(){try{hlsP.startLoad()}catch(e){}},3000);
      }
      else if(data.type===Hls.ErrorTypes.MEDIA_ERROR){log('Media error - recovering');hlsP.recoverMediaError()}
      else{shErr('Fatal: '+data.details)}
    }
  });
}

// ================================
// DASH + CLEARKEY - FIXED!
// ================================
function iDASH(u,h,drm){
  log('=== DASH INIT ===');

  if(typeof dashjs==='undefined'){shErr('dash.js not loaded');return}

  dashP = dashjs.MediaPlayer().create();

  // Settings
  dashP.updateSettings({
    streaming:{
      buffer:{fastSwitchEnabled:true},
      abr:{autoSwitchBitrate:{video:true,audio:true}}
    }
  });

  // ===== CLEARKEY DRM =====
  if(drm && drm.type==='clearkey'){
    log('--- ClearKey Setup ---');

    // Convert keyId and key to base64url
    var kidB64 = toBase64url(drm.keyId);
    var keyB64 = toBase64url(drm.key);

    log('KID input: '+drm.keyId);
    log('KID base64url: '+kidB64);
    log('KEY input: '+drm.key);
    log('KEY base64url: '+keyB64);

    if(kidB64 && keyB64){
      var ck = {};
      ck[kidB64] = keyB64;

      var protData = {
        'org.w3.clearkey': {
          clearkeys: ck
        }
      };

      log('Protection data: '+JSON.stringify(protData));

      try{
        dashP.setProtectionData(protData);
        log('‚úÖ ClearKey protection set!');
      }catch(e){
        log('‚ùå setProtectionData error: '+e.message);
      }
    } else {
      log('‚ùå Key conversion failed!');
    }
  }

  // ===== EVENTS - SAFE REGISTRATION =====
  var events = dashjs.MediaPlayer.events;
  log('Available events check...');

  // Stream Initialized
  if(events.STREAM_INITIALIZED){
    dashP.on(events.STREAM_INITIALIZED, function(){
      log('‚úÖ DASH Stream Initialized');
      setTimeout(function(){
        bDQ();
        vid.play().then(function(){log('‚ñ∂ Playing')}).catch(function(){log('Autoplay blocked')});
      },1500);
    });
    log('‚úì STREAM_INITIALIZED registered');
  }

  // Quality Change
  if(events.QUALITY_CHANGE_RENDERED){
    dashP.on(events.QUALITY_CHANGE_RENDERED, function(e){
      if(e && e.mediaType==='video') uDQ(e.newQuality);
    });
    log('‚úì QUALITY_CHANGE_RENDERED registered');
  }

  // Error
  if(events.ERROR){
    dashP.on(events.ERROR, function(e){
      var msg = 'unknown';
      try{msg=JSON.stringify(e.error||e).substring(0,200)}catch(x){msg=String(e)}
      log('‚ùå DASH Error: '+msg);
    });
    log('‚úì ERROR registered');
  }

  // Playback Error (might not exist in all versions)
  try{
    if(events.PLAYBACK_ERROR){
      dashP.on(events.PLAYBACK_ERROR, function(e){
        log('‚ùå Playback error');
      });
    }
  }catch(e){}

  // Protection events (might not exist)
  try{
    if(events.KEY_SESSION_CREATED) dashP.on(events.KEY_SESSION_CREATED, function(){log('üîë Key session created')});
    if(events.KEY_STATUSES_CHANGED) dashP.on(events.KEY_STATUSES_CHANGED, function(){log('üîë Key status changed')});
    if(events.PROTECTION_CREATED) dashP.on(events.PROTECTION_CREATED, function(){log('üîë Protection created')});
  }catch(e){}

  // ===== INITIALIZE =====
  try{
    dashP.initialize(vid, u, false);
    log('‚úÖ DASH initialized with URL: '+u.substring(0,80));
  }catch(e){
    log('‚ùå DASH init failed: '+e.message);
    shErr('DASH init failed: '+e.message);
  }
}

// ================================
// QUALITY
// ================================
function bHQ(l){
  qM.innerHTML='<div class="mn-t">Quality</div>';
  var 
