<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üé¨ Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--pri:#6C5CE7;--pri2:#A29BFE;--acc:#00CEC9;--bg:#0a0a0f;--bgc:#12121a;--bgctrl:rgba(10,10,15,0.92);--tx:#fff;--txd:#8b8b9e;--red:#FF6B6B;--g1:linear-gradient(135deg,#6C5CE7,#00CEC9);--g2:linear-gradient(135deg,#fd79a8,#6C5CE7)}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow-x:hidden}
    .loader{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s,visibility .4s}
    .loader.hide{opacity:0;visibility:hidden;pointer-events:none}
    .spin{width:50px;height:50px;border:4px solid rgba(108,92,231,.2);border-top-color:var(--pri);border-radius:50%;animation:sp .7s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .loader p{margin-top:16px;color:var(--txd);font-weight:500;font-size:15px}

    .err{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;z-index:9998;padding:20px;text-align:center}
    .err.show{display:flex}
    .err .material-icons-round{font-size:72px;color:var(--red);margin-bottom:16px}
    .err h2{font-size:22px;margin-bottom:8px}
    .err p{color:var(--txd);max-width:450px;line-height:1.6;font-size:15px}
    .err pre{background:rgba(255,255,255,.05);padding:12px;border-radius:8px;margin-top:12px;font-size:11px;color:var(--red);max-width:500px;overflow-x:auto;text-align:left;white-space:pre-wrap}
    .err a{margin-top:20px;padding:12px 28px;background:var(--g1);border:none;color:#fff;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}

    .land{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px 20px;text-align:center}
    .land.show{display:flex}
    .land-logo{width:90px;height:90px;background:var(--g1);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:44px;margin-bottom:20px;box-shadow:0 16px 50px rgba(108,92,231,.3)}
    .land h1{font-size:28px;margin-bottom:10px}
    .land>p{color:var(--txd);font-size:15px;max-width:480px;line-height:1.7;margin-bottom:28px}
    .ubox{background:var(--bgc);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:20px;text-align:left;max-width:460px;width:100%}
    .ubox h3{font-size:12px;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
    .ubox code{display:block;background:rgba(255,255,255,.04);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:6px;color:var(--pri2);word-break:break-all}

    .hdr{background:var(--bgc);border-bottom:1px solid rgba(255,255,255,.05);padding:12px 18px;display:flex;align-items:center;gap:12px}
    .hdr-logo{width:40px;height:40px;border-radius:11px;background:var(--g1);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .hdr-info{flex:1;min-width:0}
    .hdr-t{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdr-m{font-size:11px;color:var(--txd);display:flex;align-items:center;gap:7px;margin-top:2px}
    .live-d{width:7px;height:7px;background:var(--red);border-radius:50%;animation:pul 2s infinite}
    @keyframes pul{0%,100%{opacity:1}50%{opacity:.35}}
    .live-t{background:var(--red);color:#fff;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;text-transform:uppercase}
    .m-logo{width:38px;height:38px;border-radius:10px;object-fit:cover;background:rgba(255,255,255,.04)}

    .pw{width:100%;background:#000}
    .pb{position:relative;width:100%;padding-top:56.25%;background:#000;cursor:pointer;overflow:hidden}
    .pb video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;background:#000}

    .buf{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:10;pointer-events:none}
    .buf.show{display:flex}
    .buf .spin{width:42px;height:42px;border-color:rgba(255,255,255,.15);border-top-color:var(--pri2)}

    .bp{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:72px;height:72px;background:rgba(108,92,231,.82);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:11;cursor:pointer;transition:transform .2s,opacity .3s;backdrop-filter:blur(8px)}
    .bp:hover{transform:translate(-50%,-50%) scale(1.08)}
    .bp .material-icons-round{font-size:36px;color:#fff;margin-left:3px}
    .bp.hide{opacity:0;pointer-events:none}

    .tst{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.5);background:rgba(0,0,0,.65);color:#fff;border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;opacity:0;z-index:50;pointer-events:none;transition:opacity .2s,transform .2s;backdrop-filter:blur(8px)}
    .tst.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .tst .material-icons-round{font-size:28px}

    .sz{position:absolute;top:0;width:50%;height:100%;display:flex;align-items:center;justify-content:center;z-index:15;pointer-events:none}
    .sz.l{left:0}.sz.r{right:0}
    .sb{background:rgba(255,255,255,.1);border-radius:50%;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transform:scale(.5);transition:opacity .3s,transform .3s}
    .sb.show{opacity:1;transform:scale(1)}
    .sb .material-icons-round{font-size:24px}
    .sb span{font-size:10px;font-weight:600;margin-top:2px}

    .ct{position:absolute;bottom:0;left:0;width:100%;background:linear-gradient(transparent,rgba(0,0,0,.85));padding:44px 12px 8px;z-index:20;transition:opacity .3s;opacity:0}
    .pb:hover .ct,.pb.cv .ct{opacity:1}

    .prw{width:100%;height:20px;display:flex;align-items:center;cursor:pointer;margin-bottom:2px}
    .prb{width:100%;height:3px;background:rgba(255,255,255,.15);border-radius:3px;position:relative;transition:height .15s}
    .prw:hover .prb{height:6px}
    .prbf,.prpl{position:absolute;top:0;left:0;height:100%;border-radius:3px;pointer-events:none}
    .prbf{background:rgba(255,255,255,.2)}
    .prpl{background:var(--g1)}
    .prth{position:absolute;top:50%;width:13px;height:13px;background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 6px rgba(0,0,0,.35);opacity:0;transition:opacity .15s;pointer-events:none}
    .prw:hover .prth{opacity:1}

    .cr{display:flex;align-items:center;justify-content:space-between}
    .cl,.crr{display:flex;align-items:center;gap:2px}
    .cb{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:#fff;border-radius:9px;cursor:pointer;transition:background .2s;position:relative}
    .cb:hover{background:rgba(255,255,255,.1)}
    .cb .material-icons-round{font-size:21px}
    .tm{font-size:11px;color:rgba(255,255,255,.7);font-weight:500;margin-left:5px;font-variant-numeric:tabular-nums;white-space:nowrap}

    .vg{display:flex;align-items:center}
    .vsw{width:0;overflow:hidden;transition:width .3s;display:flex;align-items:center}
    .vg:hover .vsw{width:65px}
    .vs{width:65px;height:3px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.15);border-radius:3px;outline:none;cursor:pointer}
    .vs::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:#fff;border-radius:50%;cursor:pointer}

    .mn{position:absolute;bottom:calc(100% + 6px);right:0;background:var(--bgctrl);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:5px 0;min-width:150px;display:none;backdrop-filter:blur(18px);box-shadow:0 14px 44px rgba(0,0,0,.45);z-index:100;max-height:260px;overflow-y:auto}
    .mn.show{display:block}
    .mn-t{padding:7px 13px;font-size:10px;font-weight:700;color:var(--txd);text-transform:uppercase;letter-spacing:1px}
    .mn-o{padding:8px 13px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:13px;font-weight:500;transition:background .15s}
    .mn-o:hover{background:rgba(255,255,255,.06)}
    .mn-o.act{color:var(--acc)}
    .mn-o.act::after{content:'check';font-family:'Material Icons Round';font-size:16px;color:var(--acc)}
    .qb{font-size:8px;background:var(--g1);padding:2px 5px;border-radius:3px;font-weight:700;margin-left:5px;color:#fff}
    .mn::-webkit-scrollbar{width:3px}
    .mn::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}

    .inf{background:var(--bgc);padding:14px 18px;border-top:1px solid rgba(255,255,255,.04)}
    .inf-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .ch{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,.04);padding:5px 11px;border-radius:16px;font-size:11px;font-weight:500;color:var(--txd)}
    .ch .material-icons-round{font-size:14px;color:var(--pri2)}
    .tb{background:var(--g2);color:#fff;padding:5px 11px;border-radius:16px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}

    .fsa .hdr,.fsa .inf,.fsa .dbg{display:none}
    .fsa .pw{width:100vw;height:100vh}
    .fsa .pb{padding-top:0;width:100%;height:100%}

    .dbg{background:var(--bgc);padding:14px 18px;border-top:1px solid rgba(255,255,255,.04);display:none}
    .dbg.show{display:block}
    .dbg h4{color:var(--acc);font-size:12px;margin-bottom:8px;cursor:pointer}
    .dbg pre{background:rgba(0,0,0,.3);padding:10px;border-radius:8px;font-size:10px;color:var(--txd);overflow-x:auto;max-height:200px;overflow-y:auto;white-space:pre-wrap;word-break:break-all}

    @media(max-width:768px){
      .hdr{padding:10px 12px}.hdr-t{font-size:13px}
      .cb{width:32px;height:32px}.cb .material-icons-round{font-size:19px}
      .tm{font-size:10px}.vg{display:none}
      .inf{padding:10px 12px}.ct{padding:30px 8px 6px}
    }
  </style>
</head>
<body>

<div class="loader" id="loader"><div class="spin"></div><p>Loading Stream...</p></div>

<div class="err" id="errS">
  <span class="material-icons-round">error_outline</span>
  <h2>Stream Error</h2>
  <p id="errM">Something went wrong.</p>
  <pre id="errD" style="display:none"></pre>
  <a href="/">‚Üê Go Home</a>
</div>

<div class="land" id="land">
  <div class="land-logo">üé¨</div>
  <h1>Stream Player</h1>
  <p>Play HLS, DASH, ClearKey DRM streams with custom headers. Quality selector, fullscreen & more.</p>
  <div class="ubox">
    <h3>üìå How to Use</h3>
    <code>yoursite.vercel.app/?id=match1</code>
    <code>yoursite.vercel.app/?id=match2</code>
    <code>yoursite.vercel.app/?id=testdash</code>
    <code>yoursite.vercel.app/?id=testdrm</code>
  </div>
</div>

<div id="main" style="display:none">
  <header class="hdr">
    <div class="hdr-logo">üé¨</div>
    <div class="hdr-info">
      <div class="hdr-t" id="mT">Loading...</div>
      <div class="hdr-m"><div class="live-d"></div><span class="live-t">LIVE</span><span id="mG">‚Äî</span></div>
    </div>
    <img id="mL" class="m-logo" src="" alt="" style="display:none">
  </header>

  <div class="pw">
    <div class="pb" id="pB">
      <video id="vid" playsinline></video>
      <div class="buf" id="bufO"><div class="spin"></div></div>
      <div class="bp" id="bigP"><span class="material-icons-round">play_arrow</span></div>
      <div class="tst" id="tst"><span class="material-icons-round" id="tI"></span><span id="tT"></span></div>
      <div class="sz l"><div class="sb" id="sL"><span class="material-icons-round">replay_10</span><span>10s</span></div></div>
      <div class="sz r"><div class="sb" id="sR"><span class="material-icons-round">forward_10</span><span>10s</span></div></div>
      <div class="ct" id="ct">
        <div class="prw" id="prW">
          <div class="prb"><div class="prbf" id="prBf"></div><div class="prpl" id="prPl"></div><div class="prth" id="prTh"></div></div>
        </div>
        <div class="cr">
          <div class="cl">
            <button class="cb" id="ppB"><span class="material-icons-round" id="ppI">play_arrow</span></button>
            <button class="cb" id="skB"><span class="material-icons-round">replay_10</span></button>
            <button class="cb" id="skF"><span class="material-icons-round">forward_10</span></button>
            <div class="vg">
              <button class="cb" id="mtB"><span class="material-icons-round" id="vI">volume_up</span></button>
              <div class="vsw"><input type="range" class="vs" id="vS" min="0" max="100" value="100"></div>
            </div>
            <span class="tm" id="tmD">0:00 / LIVE</span>
          </div>
          <div class="crr">
            <button class="cb" id="spB">
              <span class="material-icons-round">speed</span>
              <div class="mn" id="spM">
                <div class="mn-o" data-s="0.25">0.25x</div>
                <div class="mn-o" data-s="0.5">0.5x</div>
                <div class="mn-o" data-s="0.75">0.75x</div>
                <div class="mn-o act" data-s="1">Normal</div>
                <div class="mn-o" data-s="1.25">1.25x</div>
                <div class="mn-o" data-s="1.5">1.5x</div>
                <div class="mn-o" data-s="2">2x</div>
              </div>
            </button>
            <button class="cb" id="qB">
              <span class="material-icons-round">tune</span>
              <div class="mn" id="qM"><div class="mn-t">Quality</div><div class="mn-o act" data-lv="-1">Auto</div></div>
            </button>
            <button class="cb" id="piB"><span class="material-icons-round">picture_in_picture_alt</span></button>
            <button class="cb" id="fsB"><span class="material-icons-round" id="fsI">fullscreen</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="inf">
    <div class="inf-r">
      <span class="tb" id="sT">‚Äî</span>
      <div class="ch"><span class="material-icons-round">hd</span><span id="cQ">Auto</span></div>
      <div class="ch"><span class="material-icons-round">speed</span><span id="cS">1x</span></div>
      <div class="ch" id="dC" style="display:none"><span class="material-icons-round">lock</span><span>ClearKey</span></div>
      <div class="ch" id="pC" style="display:none"><span class="material-icons-round">vpn_lock</span><span>Proxy</span></div>
    </div>
  </div>

  <div class="dbg" id="dbg">
    <h4 onclick="$('dbg').classList.remove('show')">üîß Debug Log (click to close)</h4>
    <pre id="dbgLog"></pre>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const vid=$('vid'),pB=$('pB'),loader=$('loader'),errS=$('errS'),errM=$('errM'),errD=$('errD');
const land=$('land'),main=$('main');
const bigP=$('bigP'),bufO=$('bufO'),ppB=$('ppB'),ppI=$('ppI');
const skB=$('skB'),skF=$('skF'),mtB=$('mtB'),vI=$('vI'),vS=$('vS'),tmD=$('tmD');
const prW=$('prW'),prPl=$('prPl'),prBf=$('prBf'),prTh=$('prTh');
const qB=$('qB'),qM=$('qM'),spB=$('spB'),spM=$('spM');
const piB=$('piB'),fsB=$('fsB'),fsI=$('fsI');
const tst=$('tst'),tI=$('tI'),tT=$('tT');
const mT=$('mT'),mG=$('mG'),mL=$('mL');
const sT=$('sT'),cQ=$('cQ'),cS=$('cS'),dC=$('dC'),pC=$('pC');
const dbg=$('dbg'),dbgLog=$('dbgLog');

let hlsP=null,dashP=null,mData=null,ctTO=null,tsTO=null,dbTO2=null,taps=0;
let logs=[];

function log(msg){
  const t=new Date().toLocaleTimeString();
  logs.push('['+t+'] '+msg);
  if(logs.length>100)logs.shift();
  dbgLog.textContent=logs.join('\n');
  console.log('[Player]',msg);
}

// Double click title to show debug
mT.addEventListener('dblclick',()=>dbg.classList.toggle('show'));

function gId(){return new URLSearchParams(window.location.search).get('id')}

// ========================
// INIT
// ========================
async function init(){
  const id=gId();
  if(!id){loader.classList.add('hide');land.classList.add('show');return}

  log('Loading match: '+id);

  try{
    const r=await fetch('/api/match?id='+encodeURIComponent(id));
    log('API response: '+r.status);

    if(!r.ok){
      let e;try{e=await r.json()}catch(x){e={error:'Not found'}}
      shErr(e.error||'Not found',JSON.stringify(e,null,2));
      return;
    }

    mData=await r.json();
    log('Match: '+mData.title);
    log('Type: '+mData.type);
    log('URL: '+mData.url);
    if(mData.drm) log('DRM: '+mData.drm.type+' KeyID:'+mData.drm.keyId);

    setUI();
    startP();
  }catch(e){
    log('INIT ERROR: '+e.message);
    shErr('Failed: '+e.message);
  }
}

function shErr(m,detail){
  loader.classList.add('hide');
  errM.textContent=m;
  if(detail){errD.textContent=detail;errD.style.display='block'}
  errS.classList.add('show');
}

function setUI(){
  mT.textContent=mData.title||'Stream';
  mG.textContent=mData.group||'Live';
  document.title=mData.title||'Player';
  if(mData.logo){mL.src=mData.logo;mL.style.display='block';mL.onerror=()=>mL.style.display='none'}
  sT.textContent=(mData.type||'?').toUpperCase();
  if(mData.drm)dC.style.display='flex';
  if(mData.headers&&Object.keys(mData.headers).length>0)pC.style.display='flex';
}

// ========================
// START PLAYER
// ========================
function startP(){
  const url=mData.url;
  const type=mData.type||autoType(url);
  const headers=mData.headers||{};
  const drm=mData.drm;
  const hasHeaders=Object.keys(headers).length>0;

  log('Player init - type:'+type+' hasHeaders:'+hasHeaders+' hasDRM:'+(!!drm));

  if(type==='hls'){
    initHLS(url,headers,hasHeaders);
  } else if(type==='dash'){
    initDASH(url,headers,drm);
  } else {
    vid.src=hasHeaders?proxyUrl(url,headers):url;
    vid.load();
  }

  loader.classList.add('hide');
  main.style.display='block';
}

function autoType(u){
  if(u.includes('.m3u8'))return'hls';
  if(u.includes('.mpd'))return'dash';
  return'direct';
}

function proxyUrl(u,h){
  return'/api/proxy?url='+encodeURIComponent(u)+'&headers='+encodeURIComponent(JSON.stringify(h));
}

// ========================
// HLS PLAYER
// ========================
function initHLS(url,headers,useProxy){
  if(!Hls.isSupported()){
    log('Hls.js not supported');
    if(vid.canPlayType('application/vnd.apple.mpegurl')){
      vid.src=useProxy?proxyUrl(url,headers):url;
      vid.load();
      return;
    }
    shErr('HLS not supported');return;
  }

  const src=useProxy?proxyUrl(url,headers):url;
  log('HLS source: '+src.substring(0,100)+'...');

  hlsP=new Hls({
    maxBufferLength:30,
    maxMaxBufferLength:60,
    enableWorker:true,
    startLevel:-1,
    backBufferLength:90,
    fragLoadingTimeOut:20000,
    manifestLoadingTimeOut:15000,
    levelLoadingTimeOut:15000
  });

  hlsP.loadSource(src);
  hlsP.attachMedia(vid);

  hlsP.on(Hls.Events.MANIFEST_PARSED,(e,d)=>{
    log('‚úÖ HLS Manifest OK! '+d.levels.length+' levels');
    buildHLSQ(d.levels);
    vid.play().catch(e=>log('Autoplay blocked'));
  });

  hlsP.on(Hls.Events.LEVEL_SWITCHED,(e,d)=>updateHLSQ(d.level));

  hlsP.on(Hls.Events.ERROR,(e,d)=>{
    log('‚ùå HLS Error: '+d.details+(d.fatal?' [FATAL]':''));
    if(d.fatal){
      if(d.type===Hls.ErrorTypes.NETWORK_ERROR){log('Retrying...');setTimeout(()=>hlsP.startLoad(),2000)}
      else if(d.type===Hls.ErrorTypes.MEDIA_ERROR){log('Recovering...');hlsP.recoverMediaError()}
    }
  });
}

// ========================
// DASH PLAYER - FIXED!
// ========================
function initDASH(url,headers,drm){
  log('=== DASH INIT ===');
  log('URL: '+url);

  dashP=dashjs.MediaPlayer().create();

  // Settings
  dashP.updateSettings({
    debug:{logLevel:1},
    streaming:{
      buffer:{
        fastSwitchEnabled:true,
        bufferTimeAtTopQuality:12,
        bufferTimeAtTopQualityLongForm:30,
        stableBufferTime:12,
        bufferToKeep:20
      },
      abr:{
        autoSwitchBitrate:{video:true,audio:true}
      },
      retryAttempts:{
        MPD:3,
        XLinkExpansion:1,
        InitializationSegment:3,
        IndexSegment:3,
        MediaSegment:3,
        BitstreamSwitchingSegment:3,
        license:3
      },
      retryIntervals:{
        MPD:2000,
        XLinkExpansion:1000,
        InitializationSegment:1000,
        IndexSegment:1000,
        MediaSegment:1000,
        BitstreamSwitchingSegment:1000,
        license:1000
      }
    }
  });

  // ===== ClearKey DRM Setup =====
  if(drm && drm.type==='clearkey'){
    log('Setting up ClearKey DRM...');
    log('KeyID: '+drm.keyId);
    log('Key: '+drm.key);

    // Method 1: Standard ClearKey format
    try {
      const protData = {
        'org.w3.clearkey': {
          clearkeys: {}
        }
      };
      protData['org.w3.clearkey'].clearkeys[drm.keyId] = drm.key;
      dashP.setProtectionData(protData);
      log('ClearKey protection data set (Method 1)');
    } catch(e) {
      log('ClearKey Method 1 failed: '+e.message);
    }

    // Also try with hex to base64 conversion
    try {
      const protData2 = {
        'org.w3.clearkey': {
          clearkeys: {}
        }
      };
      // Try hex format
      const kidB64 = hexToBase64url(drm.keyId);
      const keyB64 = hexToBase64url(drm.key);
      if(kidB64 && keyB64) {
        protData2['org.w3.clearkey'].clearkeys[kidB64] = keyB64;
        dashP.setProtectionData(protData2);
        log('ClearKey also set with base64url format');
        log('  KID b64url: '+kidB64);
        log('  KEY b64url: '+keyB64);
      }
    } catch(e2) {
      log('ClearKey Method 2 note: '+e2.message);
    }
  }

  // ===== Custom Headers via XHR Filter =====
  if(headers && Object.keys(headers).length>0){
    log('Setting custom headers for DASH');

    // Use request interceptor
    dashP.extend('RequestModifier', function () {
      return {
        modifyRequestHeader: function (xhr) {
          if(headers['Referer']) try{xhr.setRequestHeader('Referer',headers['Referer'])}catch(e){}
          if(headers['Origin']) try{xhr.setRequestHeader('Origin',headers['Origin'])}catch(e){}
          if(headers['User-Agent']) try{xhr.setRequestHeader('User-Agent',headers['User-Agent'])}catch(e){}
          if(headers['Cookie']) try{xhr.setRequestHeader('Cookie',headers['Cookie'])}catch(e){}
          return xhr;
        },
        modifyRequestURL: function (url) {
          return url;
        }
      };
    }, true);
  }

  // ===== DASH Events =====
  dashP.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function(){
    log('‚úÖ DASH Stream Initialized!');
    setTimeout(()=>{
      buildDASHQ();
      vid.play().then(()=>log('‚ñ∂ DASH Playing')).catch(e=>log('Autoplay blocked: '+e.message));
    },1500);
  });

  dashP.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, function(e){
    if(e.mediaType==='video'){
      log('DASH quality ‚Üí '+e.newQuality);
      updateDASHQ(e.newQuality);
    }
  });

  dashP.on(dashjs.MediaPlayer.events.ERROR, function(e){
    log('‚ùå DASH Error: '+JSON.stringify(e.error||{}).substring(0,200));
  });

  dashP.on(dashjs.MediaPlayer.events.PLAYBACK_ERROR, function(e){
    log('‚ùå DASH Playback Error: '+(e.error||'unknown'));
  });

  dashP.on(dashjs.MediaPlayer.events.KEY_SYSTEM_SELECTED, function(e){
    log('üîë Key system selected: '+(e.data?.keySystem?.systemString||'unknown'));
  });

  dashP.on(dashjs.MediaPlayer.events.KEY_SESSION_CREATED, function(){
    log('üîë Key session created');
  });

  dashP.on(dashjs.MediaPlayer.events.KEY_STATUSES_CHANGED, function(e){
    log('üîë Key status changed');
  });

  dashP.on(dashjs.MediaPlayer.events.LICENSE_REQUEST_COMPLETE, function(e){
    log('üîë License request complete, error: '+(e.error||'none'));
  });

  dashP.on(dashjs.MediaPlayer.events.PROTECTION_CREATED, function(){
    log('üîë Protection created');
  });

  dashP.on(dashjs.MediaPlayer.events.PROTECTION_DESTROYED, function(){
    log('üîë Protection destroyed');
  });

  // ===== Initialize =====
  // DASH: Direct URL, NO proxy! DASH.js handles its own requests
  dashP.initialize(vid, url, false);
  log('DASH player initialized with direct URL');
}

// ===== Hex to Base64URL conversion =====
function hexToBase64url(hex) {
  // Check if it's already base64
  if(hex.includes('=') || hex.includes('+') || hex.includes('/')) {
    // Already base64, convert to base64url
    return hex.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  // Check if valid hex
  if(!/^[0-9a-fA-F]+$/.test(hex)) {
    return null; // Not hex, maybe already base64url or plain key
  }

  try {
    const bytes = [];
    for(let i=0; i<hex.length; i+=2){
      bytes.push(parseInt(hex.substr(i,2),16));
    }
    const b64 = btoa(String.fromCharCode.apply(null, bytes));
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  } catch(e) {
    return null;
  }
}

// ========================
// QUALITY CONTROLS
// ========================
function buildHLSQ(lvs){
  qM.innerHTML='<div class="mn-t">Quality</div>';
  const a=mkOpt('Auto',-1,true);
  a.onclick=e=>{e.stopPropagation();setHLSQ(-1)};
  qM.appendChild(a);

  lvs.map((l,i)=>({...l,i})).sort((a,b)=>(b.height||0)-(a.height||0)).forEach(l=>{
    let lb=l.height?l.height+'p':Math.round((l.bitrate||0)/1000)+'kbps';
    let bd='';if(l.height>=2160)bd='4K';else if(l.height>=1080)bd='FHD';else if(l.height>=720)bd='HD';
    const o=mkOpt(lb,l.i,false,bd);
    o.onclick=e=>{e.stopPropagation();setHLSQ(l.i)};
    qM.appendChild(o);
  });
}

function mkOpt(lb,lv,ac,bd){
  const d=document.createElement('div');
  d.className='mn-o'+(ac?' act':'');d.dataset.lv=lv;
  d.innerHTML=lb+(bd?'<span class="qb">'+bd+'</span>':'');
  return d;
}

function setHLSQ(lv){
  if(!hlsP)return;hlsP.currentLevel=lv;
  qM.querySelectorAll('.mn-o').forEach(o=>o.classList.toggle('act',parseInt(o.dataset.lv)===lv));
  cQ.textContent=lv===-1?'Auto':(hlsP.levels[lv]?.height?hlsP.levels[lv].height+'p':'Custom');
  qM.classList.remove('show');
}

function updateHLSQ(lv){
  if(!hlsP||!hlsP.levels[lv])return;
  const l=hlsP.levels[lv];
  const lb=l.height?l.height+'p':Math.round(l.bitrate/1000)+'kbps';
  if(hlsP.currentLevel===-1)cQ.textContent='Auto ('+lb+')';
}

function buildDASHQ(){
  if(!dashP)return;
  const ls=dashP.getBitrateInfoListFor('video');
  if(!ls||!ls.length){log('No DASH quality levels');return}
  log('DASH quality levels: '+ls.length);

  qM.innerHTML='<div class="mn-t">Quality</div>';
  const a=mkOpt('Auto',-1,true);
  a.onclick=e=>{e.stopPropagation();setDASHQ(-1)};
  qM.appendChild(a);

  [...ls].sort((a,b)=>(b.height||0)-(a.height||0)).forEach(i=>{
    let lb=i.height?i.height+'p':Math.round(i.bitrate/1000)+'kbps';
    let bd='';if(i.height>=2160)bd='4K';else if(i.height>=1080)bd='FHD';else if(i.height>=720)bd='HD';
    const o=mkOpt(lb,i.qualityIndex,false,bd);
    o.onclick=e=>{e.stopPropagation();setDASHQ(i.qualityIndex)};
    qM.appendChild(o);
    log('  Level '+i.qualityIndex+': '+(i.height||'?')+'p');
  });
}

function setDASHQ(qi){
  if(!dashP)return;
  if(qi===-1){
    dashP.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:true}}}});
    cQ.textContent='Auto';
  }else{
    dashP.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:false}}}});
    dashP.setQualityFor('video',qi);
    const ls=dashP.getBitrateInfoListFor('video');
    const i=ls.find(l=>l.qualityIndex===qi);
    cQ.textContent=i?.height?i.height+'p':Math.round((i?.bitrate||0)/1000)+'kbps';
  }
  qM.querySelectorAll('.mn-o').forEach(o=>o.classList.toggle('act',parseInt(o.dataset.lv)===qi));
  qM.classList.remove('show');
}

function updateDASHQ(qi){
  const ls=dashP.getBitrateInfoListFor('video');
  if(!ls||!ls[qi])return;
  const lb=ls[qi].height?ls[qi].height+'p':Math.round(ls[qi].bitrate/1000)+'kbps';
  const s=dashP.getSettings();
  if(s.streaming.abr.autoSwitchBitrate.video)cQ.textContent='Auto ('+lb+')';
}

// ========================
// PLAYBACK CONTROLS
// ========================
function tgl(){vid.paused?vid.play().catch(e=>log('Play err: '+e.message)):vid.pause()}

vid.onplay=()=>{ppI.textContent='pause';bigP.classList.add('hide');log('‚ñ∂ Playing')};
vid.onpause=()=>{ppI.textContent='play_arrow';bigP.classList.remove('hide')};
vid.onwaiting=()=>{bufO.classList.add('show');log('‚è≥ Buffering')};
vid.oncanplay=()=>{bufO.classList.remove('show');log('‚úÖ Ready')};
vid.onplaying=()=>{bufO.classList.remove('show')};
vid.onerror=()=>{
  const e=vid.error;
  log('‚ùå Video Error: code='+(e?e.code:'?')+' msg='+(e?e.message:'unknown'));
};

ppB.onclick=e=>{e.stopPropagation();tgl()};
bigP.onclick=e=>{e.stopPropagation();tgl()};
skB.onclick=e=>{e.stopPropagation();vid.currentTime=Math.max(0,vid.currentTime-10);shT('replay_10','-10s')};
skF.onclick=e=>{e.stopPropagation();vid.currentTime=Math.min(vid.duration||Infinity,vid.currentTime+10);shT('forward_10','+10s')};

mtB.onclick=e=>{e.stopPropagation();vid.muted=!vid.muted;uV()};
vS.oninput=()=>{vid.volume=vS.value/100;vid.muted=false;uV()};
function uV(){vI.textContent=vid.muted||vid.volume===0?'volume_off':vid.volume<.5?'volume_down':'volume_up';vS.value=vid.muted?0:vid.volume*100}

vid.ontimeupdate=()=>{
  if(!vid.duration||!isFinite(vid.duration)){tmD.textContent=fmt(vid.currentTime)+' / LIVE';prPl.style.width='100%';return}
  const p=(vid.currentTime/vid.duration)*100;prPl.style.width=p+'%';prTh.style.left=p+'%';
  tmD.textContent=fmt(vid.currentTime)+' / '+fmt(vid.duration);
};

vid.onprogress=()=>{
  if(vid.buffered.length>0&&vid.duration&&isFinite(vid.duration))
    prBf.style.width=(vid.buffered.end(vid.buffered.length-1)/vid.duration*100)+'%';
};

let skg=false;
prW.onmousedown=stSk;prW.ontouchstart=stSk;
function stSk(e){skg=true;doSk(e);document.addEventListener('mousemove',doSk);document.addEventListener('mouseup',spSk);document.addEventListener('touchmove',doSk,{passive:true});document.addEventListener('touchend',spSk)}
function doSk(e){if(!skg||!vid.duration||!isFinite(vid.duration))return;const r=prW.getBoundingClientRect();const x=e.touches?e.touches[0].clientX:e.clientX;vid.currentTime=Math.max(0,Math.min(1,(x-r.left)/r.width))*vid.duration}
function spSk(){skg=false;document.removeEventListener('mousemove',doSk);document.removeEventListener('mouseup',spSk);document.removeEventListener('touchmove',doSk);document.removeEventListener('touchend',spSk)}

qB.onclick=e=>{e.stopPropagation();spM.classList.remove('show');qM.classList.toggle('show')};
spB.onclick=e=>{e.stopPropagation();qM.classList.remove('show');spM.classList.toggle('show')};

document.querySelectorAll('#spM .mn-o').forEach(o=>{
  o.onclick=e=>{
    e.stopPropagation();const s=parseFloat(o.dataset.s);vid.playbackRate=s;
    document.querySelectorAll('#spM .mn-o').forEach(x=>x.classList.remove('act'));
    o.classList.add('act');cS.textContent=s===1?'1x':s+'x';spM.classList.remove('show');
  };
});

piB.onclick=async e=>{e.stopPropagation();try{document.pictureInPictureElement?await document.exitPictureInPicture():await vid.requestPictureInPicture()}catch(x){}};

fsB.onclick=e=>{e.stopPropagation();tFS()};
function tFS(){if(!document.fullscreenElement&&!document.webkitFullscreenElement){const el=document.documentElement;(el.requestFullscreen||el.webkitRequestFullscreen).call(el)}else{(document.exitFullscreen||document.webkitExitFullscreen).call(document)}}
document.addEventListener('fullscreenchange',fC);document.addEventListener('webkitfullscreenchange',fC);
function fC(){const f=document.fullscreenElement||document.webkitFullscreenElement;document.body.classList.toggle('fsa',!!f);fsI.textContent=f?'fullscreen_exit':'fullscreen'}

function shC(){pB.classList.add('cv');clearTimeout(ctTO);ctTO=setTimeout(()=>{if(!vid.paused)pB.classList.remove('cv')},3000)}
pB.onmousemove=shC;pB.addEventListener('touchstart',shC,{passive:true});

pB.onclick=e=>{
  if(e.target.closest('.ct')||e.target.closest('.bp'))return;
  qM.classList.remove('show');spM.classList.remove('show');
  taps++;
  if(taps===1){dbTO2=setTimeout(()=>{taps=0;tgl()},300)}
  else if(taps===2){clearTimeout(dbTO2);taps=0;const r=pB.getBoundingClientRect();const x=e.clientX-r.left;
    if(x<r.width/2){vid.currentTime=Math.max(0,vid.currentTime-10);const b=$('sL');b.classList.add('show');setTimeout(()=>b.classList.remove('show'),500)}
    else{vid.currentTime=Math.min(vid.duration||Infinity,vid.currentTime+10);const b=$('sR');b.classList.add('show');setTimeout(()=>b.classList.remove('show'),500)}}
};

document.onclick=e=>{if(!e.target.closest('#qB'))qM.classList.remove('show');if(!e.target.closest('#spB'))spM.classList.remove('show')};
function shT(i,t){tI.textContent=i;tT.textContent=t;tst.classList.add('show');clearTimeout(tsTO);tsTO=setTimeout(()=>tst.classList.remove('show'),700)}

document.onkeydown=e=>{
  if(e.target.tagName==='INPUT')return;
  switch(e.key.toLowerCase()){
    case' ':case'k':e.preventDefault();tgl();shT(vid.paused?'play_arrow':'pause',vid.paused?'Paused':'Playing');break;
    case'arrowleft':e.preventDefault();vid.currentTime=Math.max(0,vid.currentTime-10);shT('replay_10','-10s');break;
    case'arrowright':e.preventDefault();vid.currentTime=Math.min(vid.duration||Infinity,vid.currentTime+10);shT('forward_10','+10s');break;
    case'arrowup':e.preventDefault();vid.volume=Math.min(1,vid.volume+.1);vS.value=vid.volume*100;uV();shT('volume_up',Math.round(vid.volume*100)+'%');break;
    case'arrowdown':e.preventDefault();vid.volume=Math.max(0,vid.volume-.1);vS.value=vid.volume*100;uV();shT('volume_down',Math.round(vid.volume*100)+'%');break;
    case'f':e.preventDefault();tFS();break;
    case'm':e.preventDefault();vid.muted=!vid.muted;uV();shT(vid.muted?'volume_off':'volume_up',vid.muted?'Muted':'Unmuted');break;
    case'p':e.preventDefault();piB.click();break;
    case'q':e.preventDefault();qM.classList.toggle('show');break;
  }
  shC();
};

function fmt(s){if(!isFinite(s)||isNaN(s))return'0:00';const h=Math.floor(s/3600),m=Math.floor(s%3600/60),sc=Math.floor(s%60);return h>0?h+':'+String(m).padStart(2,'0')+':'+String(sc).padStart(2,'0'):m+':'+String(sc).padStart(2,'0')}

window.onbeforeunload=()=>{if(hlsP)hlsP.destroy();if(dashP)dashP.reset()};

init();
</script>
</body>
</html>
