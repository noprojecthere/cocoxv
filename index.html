<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üé¨ Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#6C5CE7;--primary-light:#A29BFE;--accent:#00CEC9;
      --bg:#0a0a0f;--bg-card:#12121a;--bg-ctrl:rgba(10,10,15,0.92);
      --text:#fff;--text-dim:#8b8b9e;--danger:#FF6B6B;--success:#00B894;
      --grad1:linear-gradient(135deg,#6C5CE7,#00CEC9);
      --grad2:linear-gradient(135deg,#fd79a8,#6C5CE7);
    }
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

    /* ===== LOADING ===== */
    .loader{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s,visibility .4s}
    .loader.hide{opacity:0;visibility:hidden}
    .spin{width:56px;height:56px;border:4px solid rgba(108,92,231,.2);border-top-color:var(--primary);border-radius:50%;animation:sp .7s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .loader p{margin-top:18px;color:var(--text-dim);font-weight:500}

    /* ===== ERROR ===== */
    .err-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;z-index:9998;padding:20px;text-align:center}
    .err-screen.show{display:flex}
    .err-screen .material-icons-round{font-size:80px;color:var(--danger);margin-bottom:16px}
    .err-screen h2{font-size:22px;margin-bottom:8px}
    .err-screen p{color:var(--text-dim);max-width:500px;line-height:1.6}
    .err-screen .home-btn{margin-top:24px;padding:12px 32px;background:var(--grad1);border:none;color:#fff;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;text-decoration:none}

    /* ===== LANDING (no ?id) ===== */
    .landing{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px 20px;text-align:center}
    .landing.show{display:flex}
    .landing .logo-big{width:100px;height:100px;background:var(--grad1);border-radius:28px;display:flex;align-items:center;justify-content:center;font-size:50px;margin-bottom:24px;box-shadow:0 20px 60px rgba(108,92,231,.3)}
    .landing h1{font-size:32px;margin-bottom:12px}
    .landing p{color:var(--text-dim);font-size:16px;max-width:500px;line-height:1.7;margin-bottom:32px}
    .landing .usage-box{background:var(--bg-card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;text-align:left;max-width:500px;width:100%}
    .landing .usage-box h3{font-size:14px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .landing .usage-box code{display:block;background:rgba(255,255,255,.05);padding:10px 16px;border-radius:8px;font-size:14px;margin-bottom:8px;color:var(--primary-light);word-break:break-all}

    /* ===== HEADER ===== */
    .header{background:var(--bg-card);border-bottom:1px solid rgba(255,255,255,.06);padding:14px 20px;display:flex;align-items:center;gap:14px}
    .header-logo{width:42px;height:42px;border-radius:12px;background:var(--grad1);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .header-info{flex:1;min-width:0}
    .header-title{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .header-meta{font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:8px;margin-top:2px}
    .live-dot{width:8px;height:8px;background:var(--danger);border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .live-tag{background:var(--danger);color:#fff;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .match-logo{width:40px;height:40px;border-radius:10px;object-fit:cover;background:rgba(255,255,255,.05)}

    /* ===== PLAYER ===== */
    .player-wrap{width:100%;background:#000;position:relative}
    .player-box{position:relative;width:100%;padding-top:56.25%;background:#000;cursor:pointer;overflow:hidden}
    .player-box video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;background:#000}

    /* Buffering */
    .buf{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:10;pointer-events:none}
    .buf.show{display:flex}
    .buf .spin{width:46px;height:46px;border-color:rgba(255,255,255,.2);border-top-color:var(--primary-light)}

    /* Big Play */
    .big-play{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:76px;height:76px;background:rgba(108,92,231,.85);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:11;cursor:pointer;transition:transform .2s,opacity .3s;backdrop-filter:blur(10px)}
    .big-play:hover{transform:translate(-50%,-50%) scale(1.1)}
    .big-play .material-icons-round{font-size:38px;color:#fff;margin-left:3px}
    .big-play.hide{opacity:0;pointer-events:none}

    /* Shortcut Toast */
    .toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.5);background:rgba(0,0,0,.7);color:#fff;border-radius:14px;padding:14px 22px;display:flex;align-items:center;gap:10px;font-size:16px;font-weight:600;opacity:0;z-index:50;pointer-events:none;transition:opacity .2s,transform .2s;backdrop-filter:blur(10px)}
    .toast.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .toast .material-icons-round{font-size:30px}

    /* Skip Bubbles */
    .skip-zone{position:absolute;top:0;width:50%;height:100%;display:flex;align-items:center;justify-content:center;z-index:15;pointer-events:none}
    .skip-zone.l{left:0}.skip-zone.r{right:0}
    .skip-bub{background:rgba(255,255,255,.12);border-radius:50%;width:90px;height:90px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transform:scale(.5);transition:opacity .3s,transform .3s;backdrop-filter:blur(6px)}
    .skip-bub.show{opacity:1;transform:scale(1)}
    .skip-bub .material-icons-round{font-size:26px}
    .skip-bub span{font-size:11px;font-weight:600;margin-top:2px}

    /* ===== CONTROLS ===== */
    .ctrls{position:absolute;bottom:0;left:0;width:100%;background:linear-gradient(transparent,rgba(0,0,0,.88));padding:50px 14px 10px;z-index:20;transition:opacity .3s;opacity:0}
    .player-box:hover .ctrls,.player-box.cv .ctrls{opacity:1}

    /* Progress */
    .prog-wrap{width:100%;height:22px;display:flex;align-items:center;cursor:pointer;margin-bottom:2px}
    .prog-bg{width:100%;height:4px;background:rgba(255,255,255,.18);border-radius:4px;position:relative;transition:height .15s}
    .prog-wrap:hover .prog-bg{height:7px}
    .prog-buf,.prog-play{position:absolute;top:0;left:0;height:100%;border-radius:4px;pointer-events:none}
    .prog-buf{background:rgba(255,255,255,.22)}
    .prog-play{background:var(--grad1)}
    .prog-thumb{position:absolute;top:50%;width:14px;height:14px;background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 8px rgba(0,0,0,.4);opacity:0;transition:opacity .15s;pointer-events:none}
    .prog-wrap:hover .prog-thumb{opacity:1}

    /* Control Row */
    .ctrl-row{display:flex;align-items:center;justify-content:space-between}
    .ctrl-l,.ctrl-r{display:flex;align-items:center;gap:2px}
    .cb{width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:#fff;border-radius:10px;cursor:pointer;transition:background .2s;position:relative}
    .cb:hover{background:rgba(255,255,255,.1)}
    .cb .material-icons-round{font-size:22px}

    .time{font-size:12px;color:rgba(255,255,255,.75);font-weight:500;margin-left:6px;font-variant-numeric:tabular-nums;white-space:nowrap}

    /* Volume */
    .vol-g{display:flex;align-items:center}
    .vol-sw{width:0;overflow:hidden;transition:width .3s;display:flex;align-items:center}
    .vol-g:hover .vol-sw{width:70px}
    .vol-s{width:70px;height:4px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.18);border-radius:4px;outline:none;cursor:pointer}
    .vol-s::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#fff;border-radius:50%;cursor:pointer}

    /* Menus */
    .menu{position:absolute;bottom:calc(100% + 8px);right:0;background:var(--bg-ctrl);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:6px 0;min-width:160px;display:none;backdrop-filter:blur(20px);box-shadow:0 16px 50px rgba(0,0,0,.5);z-index:100;max-height:280px;overflow-y:auto}
    .menu.show{display:block}
    .menu-title{padding:8px 14px;font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
    .menu-opt{padding:9px 14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:13px;font-weight:500;transition:background .15s}
    .menu-opt:hover{background:rgba(255,255,255,.07)}
    .menu-opt.active{color:var(--accent)}
    .menu-opt.active::after{content:'check';font-family:'Material Icons Round';font-size:17px;color:var(--accent)}
    .q-badge{font-size:9px;background:var(--grad1);padding:2px 6px;border-radius:4px;font-weight:700;margin-left:6px;color:#fff}

    .menu::-webkit-scrollbar{width:3px}
    .menu::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}

    /* ===== INFO PANEL ===== */
    .info{background:var(--bg-card);padding:16px 20px;border-top:1px solid rgba(255,255,255,.04)}
    .info-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,.05);padding:5px 12px;border-radius:18px;font-size:12px;font-weight:500;color:var(--text-dim)}
    .chip .material-icons-round{font-size:15px;color:var(--primary-light)}
    .type-badge{background:var(--grad2);color:#fff;padding:5px 12px;border-radius:18px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}

    /* ===== FULLSCREEN ===== */
    .fs-active .header,.fs-active .info{display:none}
    .fs-active .player-wrap{width:100vw;height:100vh}
    .fs-active .player-box{padding-top:0;width:100%;height:100%}

    /* ===== MOBILE ===== */
    @media(max-width:768px){
      .header{padding:10px 14px}
      .header-title{font-size:14px}
      .cb{width:34px;height:34px}
      .cb .material-icons-round{font-size:20px}
      .time{font-size:11px}
      .vol-g{display:none}
      .info{padding:12px 14px}
      .ctrls{padding:36px 8px 8px}
    }
  </style>
</head>
<body>

<!-- LOADER -->
<div class="loader" id="loader">
  <div class="spin"></div>
  <p>Loading Stream...</p>
</div>

<!-- ERROR -->
<div class="err-screen" id="errScreen">
  <span class="material-icons-round">error_outline</span>
  <h2>Stream Error</h2>
  <p id="errMsg">Something went wrong.</p>
  <a class="home-btn" href="/">‚Üê Go Home</a>
</div>

<!-- LANDING (no ?id) -->
<div class="landing" id="landing">
  <div class="logo-big">üé¨</div>
  <h1>Stream Player</h1>
  <p>Play HLS, DASH, ClearKey DRM streams with custom headers support. Beautiful player with quality selector.</p>
  <div class="usage-box">
    <h3>üìå How to Use</h3>
    <code>yoursite.vercel.app/?id=match1</code>
    <code>yoursite.vercel.app/?id=match2</code>
    <p style="color:var(--text-dim);font-size:13px;margin-top:12px;line-height:1.6">Add match JSON files in <strong>public/matches/</strong> folder. Each file contains stream URL, headers, DRM keys etc.</p>
  </div>
</div>

<!-- MAIN PLAYER -->
<div id="main" style="display:none">

  <!-- Header -->
  <header class="header" id="hdr">
    <div class="header-logo">üé¨</div>
    <div class="header-info">
      <div class="header-title" id="mTitle">Loading...</div>
      <div class="header-meta">
        <div class="live-dot"></div>
        <span class="live-tag">LIVE</span>
        <span id="mGroup">‚Äî</span>
      </div>
    </div>
    <img id="mLogo" class="match-logo" src="" alt="" style="display:none">
  </header>

  <!-- Player -->
  <div class="player-wrap">
    <div class="player-box" id="pBox">
      <video id="vid" playsinline></video>

      <div class="buf" id="bufO"><div class="spin"></div></div>

      <div class="big-play" id="bigPlay">
        <span class="material-icons-round">play_arrow</span>
      </div>

      <div class="toast" id="toast">
        <span class="material-icons-round" id="toastIc"></span>
        <span id="toastTx"></span>
      </div>

      <div class="skip-zone l"><div class="skip-bub" id="skipL"><span class="material-icons-round">replay_10</span><span>10s</span></div></div>
      <div class="skip-zone r"><div class="skip-bub" id="skipR"><span class="material-icons-round">forward_10</span><span>10s</span></div></div>

      <!-- Controls -->
      <div class="ctrls" id="ctrls">
        <div class="prog-wrap" id="progW">
          <div class="prog-bg">
            <div class="prog-buf" id="progB"></div>
            <div class="prog-play" id="progP"></div>
            <div class="prog-thumb" id="progT"></div>
          </div>
        </div>

        <div class="ctrl-row">
          <div class="ctrl-l">
            <button class="cb" id="ppBtn" title="Play/Pause"><span class="material-icons-round" id="ppIc">play_arrow</span></button>
            <button class="cb" id="skBk" title="Rewind 10s"><span class="material-icons-round">replay_10</span></button>
            <button class="cb" id="skFw" title="Forward 10s"><span class="material-icons-round">forward_10</span></button>
            <div class="vol-g">
              <button class="cb" id="muteB" title="Mute"><span class="material-icons-round" id="volIc">volume_up</span></button>
              <div class="vol-sw"><input type="range" class="vol-s" id="volS" min="0" max="100" value="100"></div>
            </div>
            <span class="time" id="timeD">0:00 / LIVE</span>
          </div>
          <div class="ctrl-r">
            <button class="cb" id="spdBtn" title="Speed">
              <span class="material-icons-round">speed</span>
              <div class="menu" id="spdM">
                <div class="menu-opt" data-s="0.25">0.25x</div>
                <div class="menu-opt" data-s="0.5">0.5x</div>
                <div class="menu-opt" data-s="0.75">0.75x</div>
                <div class="menu-opt active" data-s="1">Normal</div>
                <div class="menu-opt" data-s="1.25">1.25x</div>
                <div class="menu-opt" data-s="1.5">1.5x</div>
                <div class="menu-opt" data-s="2">2x</div>
              </div>
            </button>
            <button class="cb" id="qBtn" title="Quality">
              <span class="material-icons-round">tune</span>
              <div class="menu" id="qM">
                <div class="menu-title">Quality</div>
                <div class="menu-opt active" data-lv="-1">Auto</div>
              </div>
            </button>
            <button class="cb" id="pipB" title="PiP"><span class="material-icons-round">picture_in_picture_alt</span></button>
            <button class="cb" id="fsBtn" title="Fullscreen"><span class="material-icons-round" id="fsIc">fullscreen</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info -->
  <div class="info" id="infoP">
    <div class="info-row">
      <span class="type-badge" id="sType">‚Äî</span>
      <div class="chip"><span class="material-icons-round">hd</span><span id="curQ">Auto</span></div>
      <div class="chip"><span class="material-icons-round">speed</span><span id="curSpd">1x</span></div>
      <div class="chip" id="drmC" style="display:none"><span class="material-icons-round">lock</span><span>ClearKey</span></div>
      <div class="chip" id="proxyC" style="display:none"><span class="material-icons-round">vpn_lock</span><span>Proxy</span></div>
    </div>
  </div>

</div>

<script>
// ============================================================
// ELEMENTS
// ============================================================
const $ = id => document.getElementById(id);
const vid = $('vid'), pBox = $('pBox'), loader = $('loader');
const errScreen = $('errScreen'), errMsg = $('errMsg');
const landing = $('landing'), main = $('main');
const bigPlay = $('bigPlay'), bufO = $('bufO');
const ppBtn = $('ppBtn'), ppIc = $('ppIc');
const skBk = $('skBk'), skFw = $('skFw');
const muteB = $('muteB'), volIc = $('volIc'), volS = $('volS');
const timeD = $('timeD');
const progW = $('progW'), progP = $('progP'), progB = $('progB'), progT = $('progT');
const qBtn = $('qBtn'), qM = $('qM');
const spdBtn = $('spdBtn'), spdM = $('spdM');
const pipB = $('pipB'), fsBtn = $('fsBtn'), fsIc = $('fsIc');
const toast = $('toast'), toastIc = $('toastIc'), toastTx = $('toastTx');
const mTitle = $('mTitle'), mGroup = $('mGroup'), mLogo = $('mLogo');
const sType = $('sType'), curQ = $('curQ'), curSpd = $('curSpd');
const drmC = $('drmC'), proxyC = $('proxyC');

let hls = null, dash = null, matchData = null;
let ctrlTO = null, toastTO = null, dblTO = null, taps = 0;

// ============================================================
// GET MATCH ID
// ============================================================
function getMatchId() {
  return new URLSearchParams(window.location.search).get('id');
}

// ============================================================
// INIT
// ============================================================
async function init() {
  const id = getMatchId();

  if (!id) {
    // Show landing page
    loader.classList.add('hide');
    landing.classList.add('show');
    return;
  }

  try {
    const res = await fetch(`/api/match?id=${encodeURIComponent(id)}`);

    if (!res.ok) {
      let errData;
      try { errData = await res.json(); } catch(e) { errData = { error: 'Not found' }; }
      showErr(errData.error || `Match "${id}" not found`);
      return;
    }

    matchData = await res.json();
    setupUI();
    startPlayer();
  } catch (e) {
    showErr('Failed to load: ' + e.message);
  }
}

function showErr(msg) {
  loader.classList.add('hide');
  errMsg.textContent = msg;
  errScreen.classList.add('show');
}

// ============================================================
// SETUP UI
// ============================================================
function setupUI() {
  mTitle.textContent = matchData.title || 'Stream';
  mGroup.textContent = matchData.group || 'Live';
  document.title = matchData.title || 'Stream Player';

  if (matchData.logo) {
    mLogo.src = matchData.logo;
    mLogo.style.display = 'block';
    mLogo.onerror = () => mLogo.style.display = 'none';
  }

  sType.textContent = (matchData.type || '?').toUpperCase();
  if (matchData.drm) drmC.style.display = 'flex';
  if (matchData.headers && Object.keys(matchData.headers).length > 0) proxyC.style.display = 'flex';
}

// ============================================================
// START PLAYER
// ============================================================
function startPlayer() {
  const url = matchData.url;
  const type = matchData.type || detectType(url);
  const headers = matchData.headers || {};
  const drm = matchData.drm;
  const hasHeaders = Object.keys(headers).length > 0;

  if (type === 'hls') {
    initHLS(url, headers, hasHeaders);
  } else if (type === 'dash') {
    initDASH(url, headers, drm);
  } else {
    vid.src = hasHeaders ? proxyUrl(url, headers) : url;
    vid.load();
  }

  loader.classList.add('hide');
  main.style.display = 'block';
}

function detectType(u) {
  if (u.includes('.m3u8')) return 'hls';
  if (u.includes('.mpd')) return 'dash';
  return 'direct';
}

function proxyUrl(url, headers) {
  return `/api/proxy?url=${encodeURIComponent(url)}&headers=${encodeURIComponent(JSON.stringify(headers))}`;
}

// ============================================================
// HLS
// ============================================================
function initHLS(url, headers, useProxy) {
  if (!Hls.isSupported()) {
    if (vid.canPlayType('application/vnd.apple.mpegurl')) {
      vid.src = useProxy ? proxyUrl(url, headers) : url;
      return;
    }
    showErr('HLS not supported');
    return;
  }

  const cfg = {
    maxBufferLength: 30,
    maxMaxBufferLength: 60,
    enableWorker: true,
    startLevel: -1,
    backBufferLength: 90
  };

  hls = new Hls(cfg);
  const src = useProxy ? proxyUrl(url, headers) : url;
  hls.loadSource(src);
  hls.attachMedia(vid);

  hls.on(Hls.Events.MANIFEST_PARSED, (_, d) => {
    console.log('HLS levels:', d.levels.length);
    buildHLSQuality(d.levels);
  });

  hls.on(Hls.Events.LEVEL_SWITCHED, (_, d) => {
    updateHLSQ(d.level);
  });

  hls.on(Hls.Events.ERROR, (_, d) => {
    console.error('HLS err:', d);
    if (d.fatal) {
      if (d.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
      else if (d.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
    }
  });
}

function buildHLSQuality(levels) {
  qM.innerHTML = '<div class="menu-title">Quality</div>';

  const auto = mkOpt('Auto', -1, true);
  auto.onclick = e => { e.stopPropagation(); setHLSQ(-1); };
  qM.appendChild(auto);

  const sorted = levels.map((l, i) => ({...l, idx: i})).sort((a, b) => (b.height||0) - (a.height||0));

  sorted.forEach(lv => {
    let label = lv.height ? `${lv.height}p` : `${Math.round((lv.bitrate||0)/1000)}kbps`;
    let badge = '';
    if (lv.height >= 2160) badge = '4K';
    else if (lv.height >= 1080) badge = 'FHD';
    else if (lv.height >= 720) badge = 'HD';

    const opt = mkOpt(label, lv.idx, false, badge);
    opt.onclick = e => { e.stopPropagation(); setHLSQ(lv.idx); };
    qM.appendChild(opt);
  });
}

function mkOpt(label, lv, active, badge) {
  const d = document.createElement('div');
  d.className = 'menu-opt' + (active ? ' active' : '');
  d.dataset.lv = lv;
  d.innerHTML = label + (badge ? `<span class="q-badge">${badge}</span>` : '');
  return d;
}

function setHLSQ(lv) {
  if (!hls) return;
  hls.currentLevel = lv;
  qM.querySelectorAll('.menu-opt').forEach(o => o.classList.toggle('active', parseInt(o.dataset.lv) === lv));
  curQ.textContent = lv === -1 ? 'Auto' : (hls.levels[lv]?.height ? `${hls.levels[lv].height}p` : 'Custom');
  qM.classList.remove('show');
}

function updateHLSQ(lv) {
  if (!hls || !hls.levels[lv]) return;
  const l = hls.levels[lv];
  const lb = l.height ? `${l.height}p` : `${Math.round(l.bitrate/1000)}kbps`;
  if (hls.currentLevel === -1) curQ.textContent = `Auto (${lb})`;
}

// ============================================================
// DASH
// ============================================================
function initDASH(url, headers, drm) {
  dash = dashjs.MediaPlayer().create();

  dash.updateSettings({
    streaming: {
      buffer: { fastSwitchEnabled: true },
      abr: { autoSwitchBitrate: { video: true, audio: true } }
    }
  });

  if (drm && drm.type === 'clearkey') {
    const pd = { 'org.w3.clearkey': { clearkeys: {} } };
    pd['org.w3.clearkey'].clearkeys[drm.keyId] = drm.key;
    dash.setProtectionData(pd);
  }

  if (headers && Object.keys(headers).length > 0) {
    dash.extend('RequestModifier', function() {
      return {
        modifyRequestHeader: function(xhr) {
          Object.entries(headers).forEach(([k, v]) => { try { xhr.setRequestHeader(k, v); } catch(e){} });
          return xhr;
        },
        modifyRequestURL: function(url) { return url; }
      };
    }, true);
  }

  dash.initialize(vid, url, false);

  dash.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
    setTimeout(buildDASHQ, 1500);
  });

  dash.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, e => {
    if (e.mediaType === 'video') updateDASHQ(e.newQuality);
  });
}

function buildDASHQ() {
  if (!dash) return;
  const list = dash.getBitrateInfoListFor('video');
  if (!list || !list.length) return;

  qM.innerHTML = '<div class="menu-title">Quality</div>';

  const auto = mkOpt('Auto', -1, true);
  auto.onclick = e => { e.stopPropagation(); setDASHQ(-1); };
  qM.appendChild(auto);

  [...list].sort((a, b) => (b.height||0) - (a.height||0)).forEach(info => {
    let label = info.height ? `${info.height}p` : `${Math.round(info.bitrate/1000)}kbps`;
    let badge = '';
    if (info.height >= 2160) badge = '4K';
    else if (info.height >= 1080) badge = 'FHD';
    else if (info.height >= 720) badge = 'HD';

    const opt = mkOpt(label, info.qualityIndex, false, badge);
    opt.onclick = e => { e.stopPropagation(); setDASHQ(info.qualityIndex); };
    qM.appendChild(opt);
  });
}

function setDASHQ(qi) {
  if (!dash) return;
  if (qi === -1) {
    dash.updateSettings({ streaming: { abr: { autoSwitchBitrate: { video: true } } } });
    curQ.textContent = 'Auto';
  } else {
    dash.updateSettings({ streaming: { abr: { autoSwitchBitrate: { video: false } } } });
    dash.setQualityFor('video', qi);
    const list = dash.getBitrateInfoListFor('video');
    const info = list.find(l => l.qualityIndex === qi);
    curQ.textContent = info?.height ? `${info.height}p` : `${Math.round((info?.bitrate||0)/1000)}kbps`;
  }
  qM.querySelectorAll('.menu-opt').forEach(o => o.classList.toggle('active', parseInt(o.dataset.lv) === qi));
  qM.classList.remove('show');
}

function updateDASHQ(qi) {
  const list = dash.getBitrateInfoListFor('video');
  if (!list[qi]) return;
  const lb = list[qi].height ? `${list[qi].height}p` : `${Math.round(list[qi].bitrate/1000)}kbps`;
  const s = dash.getSettings();
  if (s.streaming.abr.autoSwitchBitrate.video) curQ.textContent = `Auto (${lb})`;
}

// ============================================================
// PLAYBACK CONTROLS
// ============================================================
function togglePlay() {
  vid.paused ? vid.play().catch(()=>{}) : vid.pause();
}

vid.onplay = () => { ppIc.textContent = 'pause'; bigPlay.classList.add('hide'); };
vid.onpause = () => { ppIc.textContent = 'play_arrow'; bigPlay.classList.remove('hide'); bigPlay.querySelector('.material-icons-round').textContent = 'play_arrow'; };
vid.onwaiting = () => bufO.classList.add('show');
vid.oncanplay = () => bufO.classList.remove('show');
vid.onplaying = () => bufO.classList.remove('show');

ppBtn.onclick = e => { e.stopPropagation(); togglePlay(); };
bigPlay.onclick = e => { e.stopPropagation(); togglePlay(); };

skBk.onclick = e => { e.stopPropagation(); vid.currentTime = Math.max(0, vid.currentTime - 10); showToast('replay_10', '-10s'); };
skFw.onclick = e => { e.stopPropagation(); vid.currentTime = Math.min(vid.duration || Infinity, vid.currentTime + 10); showToast('forward_10', '+10s'); };

// Volume
muteB.onclick = e => { e.stopPropagation(); vid.muted = !vid.muted; updVol(); };
volS.oninput = () => { vid.volume = volS.value / 100; vid.muted = false; updVol(); };

function updVol() {
  volIc.textContent = vid.muted || vid.volume === 0 ? 'volume_off' : vid.volume < .5 ? 'volume_down' : 'volume_up';
  volS.value = vid.muted ? 0 : vid.volume * 100;
}

// Time & Progress
vid.ontimeupdate = () => {
  if (!vid.duration || !isFinite(vid.duration)) {
    timeD.textContent = fmt(vid.currentTime) + ' / LIVE';
    progP.style.width = '100%';
    return;
  }
  const pct = (vid.currentTime / vid.duration) * 100;
  progP.style.width = pct + '%';
  progT.style.left = pct + '%';
  timeD.textContent = fmt(vid.currentTime) + ' / ' + fmt(vid.duration);
};

vid.onprogress = () => {
  if (vid.buffered.length > 0 && vid.duration && isFinite(vid.duration)) {
    progB.style.width = (vid.buffered.end(vid.buffered.length - 1) / vid.duration * 100) + '%';
  }
};

// Seeking
let seeking = false;
progW.onmousedown = startSeek;
progW.ontouchstart = startSeek;

function startSeek(e) {
  seeking = true;
  doSeek(e);
  document.addEventListener('mousemove', doSeek);
  document.addEventListener('mouseup', stopSeek);
  document.addEventListener('touchmove', doSeek, { passive: true });
  document.addEventListener('touchend', stopSeek);
}

function doSeek(e) {
  if (!seeking || !vid.duration || !isFinite(vid.duration)) return;
  const r = progW.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX);
  let pct = Math.max(0, Math.min(1, (x - r.left) / r.width));
  vid.currentTime = pct * vid.duration;
}

function stopSeek() {
  seeking = false;
  document.removeEventListener('mousemove', doSeek);
  document.removeEventListener('mouseup', stopSeek);
  document.removeEventListener('touchmove', doSeek);
  document.removeEventListener('touchend', stopSeek);
}

// Quality/Speed menus
qBtn.onclick = e => { e.stopPropagation(); spdM.classList.remove('show'); qM.classList.toggle('show'); };
spdBtn.onclick = e => { e.stopPropagation(); qM.classList.remove('show'); spdM.classList.toggle('show'); };

document.querySelectorAll('#spdM .menu-opt').forEach(o => {
  o.onclick = e => {
    e.stopPropagation();
    const s = parseFloat(o.dataset.s);
    vid.playbackRate = s;
    document.querySelectorAll('#spdM .menu-opt').forEach(x => x.classList.remove('active'));
    o.classList.add('active');
    curSpd.textContent = s === 1 ? '1x' : s + 'x';
    spdM.classList.remove('show');
  };
});

// PiP
pipB.onclick = async e => {
  e.stopPropagation();
  try {
    document.pictureInPictureElement ? await document.exitPictureInPicture() : await vid.requestPictureInPicture();
  } catch(e) {}
};

// Fullscreen
fsBtn.onclick = e => { e.stopPropagation(); toggleFS(); };

function toggleFS() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    const el = document.documentElement;
    (el.requestFullscreen || el.webkitRequestFullscreen).call(el);
  } else {
    (document.exitFullscreen || document.webkitExitFullscreen).call(document);
  }
}

document.addEventListener('fullscreenchange', fsChange);
document.addEventListener('webkitfullscreenchange', fsChange);
function fsChange() {
  const isFS = document.fullscreenElement || document.webkitFullscreenElement;
  document.body.classList.toggle('fs-active', !!isFS);
  fsIc.textContent = isFS ? 'fullscreen_exit' : 'fullscreen';
}

// Controls auto-hide
function showCtrls() {
  pBox.classList.add('cv');
  clearTimeout(ctrlTO);
  ctrlTO = setTimeout(() => { if (!vid.paused) pBox.classList.remove('cv'); }, 3000);
}
pBox.onmousemove = showCtrls;
pBox.ontouchstart = showCtrls;

// Click = play/pause + double tap = skip
pBox.onclick = e => {
  if (e.target.closest('.ctrls') || e.target.closest('.big-play')) return;
  qM.classList.remove('show');
  spdM.classList.remove('show');

  taps++;
  if (taps === 1) {
    dblTO = setTimeout(() => { taps = 0; togglePlay(); }, 300);
  } else if (taps === 2) {
    clearTimeout(dblTO);
    taps = 0;
    const r = pBox.getBoundingClientRect();
    const x = e.clientX - r.left;
    if (x < r.width / 2) {
      vid.currentTime = Math.max(0, vid.currentTime - 10);
      const b = $('skipL'); b.classList.add('show'); setTimeout(() => b.classList.remove('show'), 500);
    } else {
      vid.currentTime = Math.min(vid.duration || Infinity, vid.currentTime + 10);
      const b = $('skipR'); b.classList.add('show'); setTimeout(() => b.classList.remove('show'), 500);
    }
  }
};

// Close menus
document.onclick = e => {
  if (!e.target.closest('#qBtn')) qM.classList.remove('show');
  if (!e.target.closest('#spdBtn')) spdM.classList.remove('show');
};

// Toast
function showToast(ic, tx) {
  toastIc.textContent = ic;
  toastTx.textContent = tx;
  toast.classList.add('show');
  clearTimeout(toastTO);
  toastTO = setTimeout(() => toast.classList.remove('show'), 700);
}

// Keyboard
document.onkeydown = e => {
  if (e.target.tagName === 'INPUT') return;
  switch(e.key.toLowerCase()) {
    case ' ': case 'k': e.preventDefault(); togglePlay(); showToast(vid.paused?'play_arrow':'pause', vid.paused?'Paused':'Playing'); break;
    case 'arrowleft': e.preventDefault(); vid.currentTime = Math.max(0, vid.currentTime-10); showToast('replay_10','-10s'); break;
    case 'arrowright': e.preventDefault(); vid.currentTime = Math.min(vid.duration||Infinity, vid.currentTime+10); showToast('forward_10','+10s'); break;
    case 'arrowup': e.preventDefault(); vid.volume = Math.min(1, vid.volume+.1); volS.value = vid.volume*100; updVol(); showToast('volume_up', Math.round(vid.volume*100)+'%'); break;
    case 'arrowdown': e.preventDefault(); vid.volume = Math.max(0, vid.volume-.1); volS.value = vid.volume*100; updVol(); showToast('volume_down', Math.round(vid.volume*100)+'%'); break;
    case 'f': e.preventDefault(); toggleFS(); break;
    case 'm': e.preventDefault(); vid.muted=!vid.muted; updVol(); showToast(vid.muted?'volume_off':'volume_up', vid.muted?'Muted':'Unmuted'); break;
    case 'p': e.preventDefault(); pipB.click(); break;
    case 'q': e.preventDefault(); qM.classList.toggle('show'); break;
  }
  showCtrls();
};

function fmt(s) {
  if (!isFinite(s) || isNaN(s)) return '0:00';
  const h = Math.floor(s/3600), m = Math.floor(s%3600/60), sec = Math.floor(s%60);
  return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` : `${m}:${String(sec).padStart(2,'0')}`;
}

// Cleanup
window.onbeforeunload = () => {
  if (hls) hls.destroy();
  if (dash) dash.reset();
};

// ============================================================
// START
// ============================================================
init();
</script>
</body>
</html>
